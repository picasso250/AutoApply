# AutoApply: 剪贴板代码自动写入工具

## 简介

`AutoApply` 是一个基于 Python 的实用工具，它通过监控 Windows 剪贴板来自动检测并应用特定格式的代码块到本地文件系统。当你从剪贴板复制包含 `---FILE: <文件名>---` 标记的代码片段时，`AutoApply` 会识别这些代码块，并根据用户的确认将其内容写入到指定的项目根目录下的相应文件。这极大地简化了从AI助手或其他来源获取代码后，将其应用到项目中的过程。

## 特性

*   **剪贴板监控：** 实时监听 Windows 剪贴板的内容变化。
*   **智能识别：** 使用正则表达式解析剪贴板内容，识别 `---FILE: <filename>---` 格式的代码块。
*   **批量处理：** 支持一次性从剪贴板内容中识别并处理多个文件代码块。
*   **用户确认：** 在写入任何文件之前，会弹出 Windows 原生消息框，详细列出将要创建或更新的文件，并征求用户确认。
*   **内容比对：** 在写入前会与现有文件内容进行比对，如果内容完全一致，则跳过写入，避免不必要的覆盖。
*   **根目录配置：** 首次运行或未设置时，会引导用户配置项目根目录，并保存到 `config.ini`。
*   **目录自动创建：** 如果目标文件的父目录不存在，会自动创建。
*   **后台运行：** 主程序窗口隐藏，通过系统托盘或控制台输出进行交互。

## 运行环境

*   操作系统：Windows
*   Python 版本：3.x (推荐 3.6+)

## 依赖

`AutoApply` 需要 `pywin32` 库来访问 Windows API 进行剪贴板监控和消息框显示。

在运行之前，请确保已安装 `pywin32`：

```bash
pip install pywin32
```

## 安装与启动

1.  **下载代码：** 将 `clipboard_code_applier.py` 文件下载到您的本地机器。

2.  **首次运行：**
    ```bash
    python clipboard_code_applier.py
    ```
    首次运行程序时，如果 `config.ini` 不存在或未配置 `root_folder`，程序会弹出一个输入框，要求您指定项目的工作根目录。这个目录是所有识别到的代码文件将要写入的基准路径。请确保输入一个有效的本地目录路径。设置后，该配置会保存到 `config.ini` 文件中。

3.  **后续运行：** 直接运行脚本即可，程序将自动读取 `config.ini` 中的配置。

## 使用方法

1.  **启动程序：** 运行 `clipboard_code_applier.py` 脚本。程序会在后台启动剪贴板监控。

2.  **复制代码：** 当您需要将代码写入项目文件时，请将以下格式的代码块复制到剪贴板中：

    ```
    ---FILE: path/to/your/file1.py---
    ```python
    # 这是 file1.py 的内容
    def hello_world():
        print("Hello from file1!")
    ```

    ---FILE: another/folder/file2.js---
    ```javascript
    // 这是 file2.js 的内容
    console.log("Hello from file2!");
    ```
    请注意以下几点：
    *   `---FILE: <文件名_带扩展名>---` 是强制性的文件标记。
    *   `<文件名_带扩展名>` 应该包含从您的项目根目录开始的相对路径。例如，如果您的根目录是 `my_project`，并且您想将文件写入 `my_project/src/utils.py`，那么文件名应该是 `src/utils.py`。
    *   代码内容必须包裹在 Markdown 代码块（``````）中。

3.  **确认写入：** 当您复制上述格式的代码到剪贴板后，`AutoApply` 会检测到变化。如果检测到需要写入的文件（即新文件或内容与现有文件不一致），它将弹出一个 Windows 确认对话框。
    *   对话框会显示所有将要处理的文件列表（文件名、状态：`创建` 或 `更新`，以及完整的写入路径）。
    *   点击 `是 (Yes)` 将代码写入到相应文件。
    *   点击 `否 (No)` 将取消本次写入操作。

4.  **查看结果：** 如果您确认写入，代码将自动创建或更新指定路径下的文件。控制台会输出写入成功或失败的信息。

## 配置

`AutoApply` 的配置存储在与脚本同目录的 `config.ini` 文件中。

```ini
[Settings]
root_folder = C:\Users\YourUser\YourProject
```

*   `root_folder`：您的项目根目录的绝对路径。您可以通过删除此文件或清空 `root_folder` 的值来重新触发根目录设置提示。

## 工作原理

1.  **ConfigManager：** 负责读取和保存 `config.ini` 文件中的配置，特别是项目根目录 `root_folder`。
2.  **ClipboardMonitor：** 创建一个隐藏的 Win32 窗口，并注册监听 `WM_CLIPBOARDUPDATE` 消息。当剪贴板内容变化时，它会通过 `win32clipboard` API 获取内容，并将其放入一个线程安全的队列 `clipboard_queue` 中。
3.  **AutoCodeApplier (主应用)：**
    *   在主 Tkinter 线程中，通过 `root.after` 定时检查 `clipboard_queue`。
    *   当队列中有新的剪贴板内容时，它会使用正则表达式 `CLIPBOARD_PATTERN` 来查找所有匹配 `---FILE: <filename>---` 格式的代码块。
    *   对于每个识别到的代码块，它会计算出目标文件的完整路径，并检查该文件是否已存在。
    *   如果文件已存在，它会读取现有内容并与剪贴板中的新内容进行比对。如果内容完全一致，则跳过此文件。
    *   如果文件是新的或内容不一致，则将其添加到待写入列表。
    *   如果待写入列表不为空，它会构建一个详细的提示消息，并使用 `win32_askyesno` 函数弹出 Windows 原生确认框。
    *   根据用户的选择，将代码内容写入到目标文件。如果目标目录不存在，会自动创建。

## 注意事项

*   **仅限 Windows：** 本工具使用了 `pywin32` 库，因此只能在 Windows 操作系统上运行。
*   **覆盖风险：** 写入操作会**覆盖**目标文件的现有内容（如果存在且与剪贴板内容不一致）。请在确认前仔细检查提示信息。
*   **编码：** 文件写入和读取均使用 UTF-8 编码。
*   **隐藏窗口：** 程序的主 Tkinter 窗口是隐藏的 (`root.withdraw()`)，因为它主要是一个后台监控工具。所有用户交互都通过原生 Windows 消息框完成。
*   **异常处理：** 对剪贴板访问和文件写入操作进行了基本的异常处理，以提高稳定性。

## 潜在改进

*   **更多操作系统支持：** 引入跨平台剪贴板库（如 `pyperclip`），但需要解决跨平台的消息监听机制。
*   **自定义模式：** 允许用户自定义代码块的匹配模式。
*   **系统托盘图标：** 提供一个系统托盘图标，方便用户进行启动/停止监控、修改配置等操作，而无需控制台。
*   **删除文件支持：** 扩展模式，支持 `---DELETE_FILE: path/to/file.py---` 等指令。
*   **文件内容预览：** 在确认对话框中，为每个文件提供一个选项来预览其完整的更改（diff）。
*   **日志记录：** 引入更完善的日志记录机制，将操作详情、警告和错误写入日志文件。

## 贡献

欢迎通过 GitHub (如果项目托管在 GitHub) 提交 Issue 或 Pull Request 来改进此工具。
